<!-- 
    ★ PSG Mobile UI - 酒馆远程加载引导器 ★ 
    使用方法：
    1. 确保您的仓库 Stockielchan/PSG-Script 已公开。
    2. 复制下方所有代码（包括 script 标签）。
    3. 在酒馆输入框中粘贴并发送，或者将其放入角色卡的“欢迎消息”中。
    4. 最好用 ```html 代码块包裹，虽然酒馆有时能直接解析 HTML。
-->

<div id="psg-root-loader" style="padding: 20px; background: #000; color: #fff; font-family: monospace; border-radius: 8px;">
    [SYSTEM] Initializing PSG Mobile UI...<br>
    [SOURCE] github.com/Stockielchan/PSG-Script<br>
    <div id="psg-loading-bar" style="width: 0%; height: 4px; background: #ff4081; transition: width 0.5s; margin-top: 10px;"></div>
</div>

<script>
(async function() {
    // === 配置区 ===
    // 使用 jsDelivr CDN 加速 GitHub Raw 文件，避免跨域和缓存问题
    // 格式: https://cdn.jsdelivr.net/gh/用户/仓库@分支/路径
    const REPO_ROOT = 'https://cdn.jsdelivr.net/gh/Stockielchan/PSG-Script@main/PSG-TC';
    
    // 如果您想使用本地调试 (需启动本地服务器)，可取消注释下面这行：
    // const REPO_ROOT = 'http://127.0.0.1:5500/同层/PSG-TC'; 

    const LOADER = document.getElementById('psg-root-loader');
    const BAR = document.getElementById('psg-loading-bar');
    const LOG = (msg) => { console.log(`[PSG-Loader] ${msg}`); if(LOADER) LOADER.innerHTML += `<br>> ${msg}`; };
    const PROGRESS = (pct) => { if(BAR) BAR.style.width = `${pct}%`; };

    try {
        LOG("Connecting to repository...");
        
        // 1. 注入样式
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = `${REPO_ROOT}/css/style.css`;
        document.head.appendChild(link);
        PROGRESS(20);
        LOG("CSS Loaded.");

        // 2. 获取 HTML 结构
        // 注意：index.html 包含完整的 html/head/body 标签，我们需要提取 body 内部的内容
        // GitHub 上您上传的是 index.html
        const htmlRes = await fetch(`${REPO_ROOT}/index.html`);
        if (!htmlRes.ok) throw new Error(`Failed to load HTML: ${htmlRes.status}`);
        const htmlText = await htmlRes.text();
        
        // 解析并提取 body 内容
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');
        
        // 创建全屏容器
        const appContainer = document.createElement('div');
        appContainer.id = 'psg-app-container';
        appContainer.style.cssText = "position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:9999; background:#fff; overflow:hidden;";
        
        // 添加一个紧急退出按钮
        const exitBtn = document.createElement('button');
        exitBtn.innerText = "✖ 退出界面";
        exitBtn.style.cssText = "position:absolute; top:5px; right:5px; z-index:100000; padding:5px 10px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:4px; cursor:pointer;";
        exitBtn.onclick = () => { document.body.removeChild(appContainer); };
        appContainer.appendChild(exitBtn);

        // 迁移节点
        Array.from(doc.body.childNodes).forEach(node => {
            if (node.tagName !== 'SCRIPT') {
                appContainer.appendChild(node.cloneNode(true));
            }
        });
        
        document.body.appendChild(appContainer);
        PROGRESS(50);
        LOG("UI Injected.");

        // 3. 顺序加载脚本
        const loadScript = (src) => new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.body.appendChild(s);
        });

        await loadScript(`${REPO_ROOT}/js/rpg-core.js`);
        PROGRESS(70);
        await loadScript(`${REPO_ROOT}/js/music-player.js`);
        PROGRESS(85);
        await loadScript(`${REPO_ROOT}/js/main.js`);
        PROGRESS(100);
        
        LOG("All Systems Ready.");
        
        // 隐藏加载器 (可选)
        setTimeout(() => { if(LOADER) LOADER.style.display = 'none'; }, 1000);

    } catch (e) {
        LOG(`ERROR: ${e.message}`);
        console.error(e);
    }
})();
</script>