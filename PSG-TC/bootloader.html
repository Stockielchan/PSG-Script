<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PSG Injector</title>
</head>
<body style="margin:0; padding:0; background:transparent;">

<div id="psg-root-loader" style="padding: 20px; background: #000; color: #fff; font-family: monospace; border-radius: 8px;">
    [SYSTEM] Initializing PSG Mobile UI (Injection Mode)...<br>
    [SOURCE] github.com/Stockielchan/PSG-Script<br>
    <div id="psg-loading-bar" style="width: 0%; height: 4px; background: #ff4081; transition: width 0.5s; margin-top: 10px;"></div>
</div>

<script>
(async function() {
    // === 配置区 ===
    // 仓库地址 (jsDelivr CDN 支持 CORS)
    const REPO_ROOT = 'https://cdn.jsdelivr.net/gh/Stockielchan/PSG-Script@main/PSG-TC';
    
    // 如果 jsDelivr 失败，可以尝试 CORS Proxy (可选备用)
    // const PROXY_ROOT = 'https://corsproxy.io/?url=' + encodeURIComponent('https://raw.githubusercontent.com/Stockielchan/PSG-Script/main/PSG-TC');

    const LOADER = document.getElementById('psg-root-loader');
    const BAR = document.getElementById('psg-loading-bar');
    const LOG = (msg) => { console.log(`[PSG-Loader] ${msg}`); if(LOADER) LOADER.innerHTML += `<br>> ${msg}`; };
    const PROGRESS = (pct) => { if(BAR) BAR.style.width = `${pct}%`; };

    // 辅助函数：加载远程文本
    const fetchText = async (url) => {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status} from ${url}`);
        return await res.text();
    };

    try {
        LOG("Connecting to repository...");
        
        // 1. 加载 CSS (直接注入 <style> 标签以确保样式优先级)
        const cssContent = await fetchText(`${REPO_ROOT}/css/style.css`);
        const style = document.createElement('style');
        style.textContent = cssContent;
        document.head.appendChild(style);
        PROGRESS(20);
        LOG("CSS Injected.");

        // 2. 获取 HTML 结构并注入当前页面 (不是 iframe)
        const htmlText = await fetchText(`${REPO_ROOT}/index.html`); // 注意：使用 index.html 作为源
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');
        
        // 创建容器覆盖层
        const appContainer = document.createElement('div');
        appContainer.id = 'psg-app-container';
        // 使用绝对定位覆盖，但不使用 iframe，这样它就在同一个 window 上
        appContainer.style.cssText = "position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:2147483647; background:#fff; overflow:hidden;";
        
        // 提取 body 内容并注入容器
        Array.from(doc.body.childNodes).forEach(node => {
            if (node.tagName !== 'SCRIPT') {
                appContainer.appendChild(node.cloneNode(true));
            }
        });
        
        // 将容器挂载到 body 根节点，突破酒馆气泡限制
        document.body.appendChild(appContainer);
        PROGRESS(50);
        LOG("DOM Injected.");

        // 3. 加载并执行 JS (eval 模式，确保在当前上下文执行)
        // 我们使用 Function() 构造函数或 eval 来执行代码，使其能访问 window.TavernHelper
        const executeScript = async (url) => {
            const code = await fetchText(url);
            // 为了安全和隔离，我们将其包裹在一个闭包中，但允许访问 window
            // 使用 indirect eval 或者动态创建 script 标签 (blob url)
            const script = document.createElement('script');
            script.textContent = code;
            document.body.appendChild(script);
        };

        LOG("Loading Core...");
        await executeScript(`${REPO_ROOT}/js/rpg-core.js`);
        PROGRESS(70);
        
        LOG("Loading Media...");
        await executeScript(`${REPO_ROOT}/js/music-player.js`);
        PROGRESS(85);
        
        LOG("Loading Main Logic...");
        await executeScript(`${REPO_ROOT}/js/main.js`);
        PROGRESS(100);
        
        LOG("Launch Complete!", "success");
        
        // 移除加载器
        setTimeout(() => { if(LOADER) LOADER.parentElement.remove(); }, 800);

    } catch (e) {
        LOG(`FATAL: ${e.message}`, "error");
        console.error(e);
    }
})();
</script>
</body>
</html>