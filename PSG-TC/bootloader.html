<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PSG Smart Loader (Cache Enabled)</title>
</head>
<body style="margin:0; padding:0; background:transparent;">

<!-- 加载界面 -->
<div id="psg-root-loader" style="padding: 20px; background: #1a1a1a; color: #fff; font-family: monospace; border-radius: 8px; border: 1px solid #333; max-width: 400px; margin: 20px;">
    <div style="font-weight:bold; color:#ff4081; margin-bottom:5px;">[SYSTEM] PSG Smart Loader</div>
    <div id="psg-status">Checking cache...</div>
    <div id="psg-loading-bar" style="width: 0%; height: 4px; background: #00e5ff; transition: width 0.3s; margin-top: 10px;"></div>
    <div id="psg-error-log" style="color: #ff5252; margin-top: 10px; font-size: 12px; display: none;"></div>
    
    <!-- 强制更新按钮 (默认隐藏) -->
    <button id="psg-force-update" style="display:none; margin-top:10px; background:#333; color:#ccc; border:1px solid #555; padding:5px 10px; cursor:pointer; font-size:12px;">
        Force Update from GitHub
    </button>
</div>

<script>
(async function() {
    // === 配置 ===
    const CONFIG = {
        REPO_ROOT: 'https://cdn.jsdelivr.net/gh/Stockielchan/PSG-Script@main/PSG-TC',
        CACHE_KEY_PREFIX: 'PSG_TC_CACHE_V1_',
        VERSION_KEY: 'PSG_TC_VERSION',
        // 如果您更新了 GitHub 代码，请务必修改这里的版本号，否则玩家不会自动更新
        CURRENT_VERSION: '2.0.1' 
    };

    const UI = {
        loader: document.getElementById('psg-root-loader'),
        status: document.getElementById('psg-status'),
        bar: document.getElementById('psg-loading-bar'),
        err: document.getElementById('psg-error-log'),
        btn: document.getElementById('psg-force-update')
    };

    const LOG = (msg) => { console.log(`[PSG] ${msg}`); UI.status.innerText = msg; };
    const ERROR = (msg) => { console.error(`[PSG] ${msg}`); UI.err.style.display='block'; UI.err.innerText = msg; };
    const PROGRESS = (pct) => { UI.bar.style.width = `${pct}%`; };

    // === 核心逻辑 ===

    // 1. 资源列表
    const RESOURCES = [
        { type: 'css', url: `${CONFIG.REPO_ROOT}/css/style.css`, key: 'style.css' },
        { type: 'html', url: `${CONFIG.REPO_ROOT}/index.html`, key: 'index.html' },
        { type: 'js', url: `${CONFIG.REPO_ROOT}/js/rpg-core.js`, key: 'rpg-core.js' },
        { type: 'js', url: `${CONFIG.REPO_ROOT}/js/music-player.js`, key: 'music-player.js' },
        { type: 'js', url: `${CONFIG.REPO_ROOT}/js/main.js`, key: 'main.js' }
    ];

    // 2. 缓存管理
    const Cache = {
        get: (key) => localStorage.getItem(CONFIG.CACHE_KEY_PREFIX + key),
        set: (key, val) => localStorage.setItem(CONFIG.CACHE_KEY_PREFIX + key, val),
        clear: () => {
            Object.keys(localStorage).forEach(k => {
                if(k.startsWith(CONFIG.CACHE_KEY_PREFIX)) localStorage.removeItem(k);
            });
            localStorage.removeItem(CONFIG.VERSION_KEY);
        },
        hasAll: () => RESOURCES.every(res => localStorage.getItem(CONFIG.CACHE_KEY_PREFIX + res.key))
    };

    // 3. 辅助函数
    const fixRelativePaths = (content, baseUrl) => {
        return content.replace(/url\(['"]?(?!http|data:)([^'"]+)['"]?\)/g, (match, path) => {
            const cleanPath = path.replace(/^\.\.\//, ''); 
            return `url('${baseUrl}/${cleanPath}')`;
        });
    };
    
    const fixHtmlPaths = (content, baseUrl) => {
        return content.replace(/src=["'](?!http|data:)([^"']+)["']/g, (match, path) => `src="${baseUrl}/${path}"`);
    };

    // 4. 下载逻辑
    const downloadResources = async () => {
        LOG("Downloading resources...");
        let completed = 0;
        for (const res of RESOURCES) {
            try {
                const response = await fetch(res.url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                let content = await response.text();
                
                // 预处理路径
                if (res.type === 'css') content = fixRelativePaths(content, CONFIG.REPO_ROOT);
                if (res.type === 'html') content = fixHtmlPaths(content, CONFIG.REPO_ROOT);
                
                Cache.set(res.key, content);
                completed++;
                PROGRESS((completed / RESOURCES.length) * 100);
            } catch (e) {
                throw new Error(`Failed to load ${res.key}: ${e.message}`);
            }
        }
        localStorage.setItem(CONFIG.VERSION_KEY, CONFIG.CURRENT_VERSION);
        LOG("Download complete.");
    };

    // 5. 注入逻辑 (从缓存读取)
    const injectFromCache = async () => {
        LOG("Injecting from cache...");
        
        try {
            // CSS
            const css = Cache.get('style.css');
            // 增加霸道样式覆盖
            const overrideCss = `
                #psg-app-container {
                    position: fixed !important; top: 0 !important; left: 0 !important;
                    width: 100vw !important; height: 100vh !important;
                    z-index: 2147483647 !important; background: #fff !important;
                    overflow: hidden !important; display: block !important;
                }
            `;
            const style = document.createElement('style');
            style.textContent = css + overrideCss;
            document.head.appendChild(style);

            // HTML
            const html = Cache.get('index.html');
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const appContainer = document.createElement('div');
            appContainer.id = 'psg-app-container';
            
            const exitBtn = document.createElement('div');
            exitBtn.innerHTML = "×";
            exitBtn.style.cssText = "position:absolute; top:10px; right:10px; z-index:2147483648; width:30px; height:30px; background:rgba(0,0,0,0.5); color:white; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer; font-weight:bold;";
            exitBtn.onclick = () => { document.body.removeChild(appContainer); };
            appContainer.appendChild(exitBtn);

            Array.from(doc.body.childNodes).forEach(node => {
                if (node.tagName !== 'SCRIPT') appContainer.appendChild(node.cloneNode(true));
            });
            document.body.appendChild(appContainer);

            // JS (IIFE Protected)
            const scripts = ['rpg-core.js', 'music-player.js', 'main.js'];
            for (const key of scripts) {
                const code = Cache.get(key);
                const script = document.createElement('script');
                // Wrap in IIFE but allow window access
                script.textContent = `(async function(){ try{ ${code} }catch(e){console.error("[PSG] Script Error:",e)} })();`;
                document.body.appendChild(script);
            }

            LOG("Launched!", "success");
            setTimeout(() => { if(UI.loader) UI.loader.parentElement.remove(); }, 800);

        } catch (e) {
            throw new Error("Injection failed: " + e.message);
        }
    };

    // === 主流程 ===
    const main = async () => {
        try {
            const cachedVersion = localStorage.getItem(CONFIG.VERSION_KEY);
            const hasCache = Cache.hasAll();

            if (!hasCache || cachedVersion !== CONFIG.CURRENT_VERSION) {
                if (cachedVersion && cachedVersion !== CONFIG.CURRENT_VERSION) {
                    LOG(`Updating: v${cachedVersion} -> v${CONFIG.CURRENT_VERSION}`);
                } else {
                    LOG("First time setup...");
                }
                await downloadResources();
            } else {
                LOG("Cache hit! Starting offline mode...");
                PROGRESS(100);
            }

            await injectFromCache();

        } catch (e) {
            ERROR(e.message);
            UI.btn.style.display = 'block'; // Show force update button
        }
    };

    // 绑定强制更新按钮
    UI.btn.onclick = async () => {
        Cache.clear();
        UI.btn.style.display = 'none';
        ERROR(""); // Clear error
        await main();
    };

    await main();

})();
</script>
</body>
</html>